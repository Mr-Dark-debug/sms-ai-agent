{% extends "base.html" %}

{% block title %}Chat with {{ phone }}{% endblock %}

{% block content %}
<div class="flex flex-col h-[calc(100vh-12rem)] max-h-[800px] animate-fade-in">
    <!-- Header -->
    <div class="flex items-center justify-between p-4 bg-[var(--bg-secondary)] border border-[var(--border)] rounded-t-2xl">
        <div class="flex items-center gap-3">
            <a href="/messages/conversations" class="p-2 hover:bg-[var(--bg-tertiary)] rounded-lg transition-colors">
                <i class="fas fa-arrow-left"></i>
            </a>
            <div>
                <h1 class="text-xl font-bold">{{ phone }}</h1>
                <p class="text-xs text-[var(--text-muted)]">Conversation History</p>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="document.getElementById('contact-modal').classList.remove('hidden')" class="p-2 hover:bg-[var(--bg-tertiary)] rounded-lg text-cyan-400" title="Contact Persona">
                <i class="fas fa-user-gear"></i>
            </button>
            <button onclick="location.reload()" class="p-2 hover:bg-[var(--bg-tertiary)] rounded-lg">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
    </div>
    
    <!-- Contact Info Bar -->
    {% if contact %}
    <div class="px-4 py-2 bg-cyan-500/10 border-x border-b border-[var(--border)] flex flex-wrap gap-x-4 gap-y-1 text-[10px]">
        {% if contact.name %}<span><i class="fas fa-user mr-1 text-cyan-400"></i>{{ contact.name }}</span>{% endif %}
        {% if contact.relation %}<span><i class="fas fa-heart mr-1 text-cyan-400"></i>{{ contact.relation }}</span>{% endif %}
        {% if contact.age %}<span><i class="fas fa-cake-candles mr-1 text-cyan-400"></i>{{ contact.age }} yrs</span>{% endif %}
        {% if contact.custom_prompt %}<span><i class="fas fa-brain mr-1 text-cyan-400"></i>Custom Prompt Active</span>{% endif %}
    </div>
    {% endif %}
    
    <!-- Chat Area -->
    <div class="flex-1 overflow-y-auto p-4 space-y-4 bg-[var(--bg-tertiary)] border-x border-[var(--border)]" id="chat-container">
        {% if history %}
            {% for msg in history %}
                <div class="flex {% if msg.direction == 'outgoing' %}justify-end{% else %}justify-start{% endif %}">
                    <div class="max-w-[80%] sm:max-w-[70%] rounded-2xl p-4 shadow-sm
                        {% if msg.direction == 'outgoing' %}
                            bg-gradient-to-br from-cyan-600 to-blue-700 text-white rounded-tr-none
                        {% else %}
                            bg-[var(--bg-secondary)] border border-[var(--border)] rounded-tl-none
                        {% endif %}">
                        <p class="text-sm whitespace-pre-wrap">{{ msg.message }}</p>
                        <div class="mt-2 flex items-center justify-between gap-4 text-[10px] {% if msg.direction == 'outgoing' %}text-cyan-100{% else %}text-[var(--text-muted)]{% endif %}">
                            <span>{{ msg.timestamp }}</span>
                            {% if msg.direction == 'outgoing' %}
                                <span><i class="fas {% if msg.status == 'sent' %}fa-check{% elif msg.status == 'delivered' %}fa-check-double{% elif msg.status == 'failed' %}fa-times text-red-300{% else %}fa-clock{% endif %}"></i> {{ msg.status|title }}</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="flex items-center justify-center h-full text-[var(--text-muted)]">
                <p>No messages in this conversation</p>
            </div>
        {% endif %}
    </div>
    
    <!-- Quick Reply Footer -->
    <div class="p-4 bg-[var(--bg-secondary)] border border-[var(--border)] rounded-b-2xl">
        <form id="reply-form" class="flex gap-2">
            <input type="hidden" name="phone_number" value="{{ phone }}">
            <input type="text" name="message" id="reply-input" placeholder="Type a message..." required
                   class="flex-1 px-4 py-2 bg-[var(--bg-tertiary)] border border-[var(--border)] rounded-xl focus:border-cyan-500 focus:ring-1 focus:ring-cyan-500">
            <button type="submit" class="p-2 bg-cyan-500 hover:bg-cyan-600 text-white rounded-xl aspect-square flex items-center justify-center">
                <i class="fas fa-paper-plane"></i>
            </button>
        </form>
    </div>
</div>

<!-- Contact Persona Modal -->
<div id="contact-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center hidden p-4">
    <div class="bg-[var(--bg-secondary)] border border-[var(--border)] w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden animate-scale-in">
        <div class="p-6 border-b border-[var(--border)] flex justify-between items-center">
            <h2 class="text-xl font-bold">Contact Persona Settings</h2>
            <button onclick="document.getElementById('contact-modal').classList.add('hidden')" class="text-[var(--text-muted)] hover:text-white">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="contact-form" class="p-6 space-y-4">
            <input type="hidden" name="phone_number" value="{{ phone }}">
            <div class="grid grid-cols-2 gap-4">
                <div class="space-y-1">
                    <label class="text-xs font-semibold text-[var(--text-muted)]">Name</label>
                    <input type="text" name="name" value="{{ contact.name or '' }}" placeholder="John Doe"
                           class="w-full px-4 py-2 bg-[var(--bg-tertiary)] border border-[var(--border)] rounded-xl focus:border-cyan-500 outline-none">
                </div>
                <div class="space-y-1">
                    <label class="text-xs font-semibold text-[var(--text-muted)]">Relation</label>
                    <input type="text" name="relation" value="{{ contact.relation or '' }}" placeholder="Friend / Mom / Boss"
                           class="w-full px-4 py-2 bg-[var(--bg-tertiary)] border border-[var(--border)] rounded-xl focus:border-cyan-500 outline-none">
                </div>
            </div>
            <div class="space-y-1">
                <label class="text-xs font-semibold text-[var(--text-muted)]">Age</label>
                <input type="number" name="age" value="{{ contact.age or '' }}" placeholder="25"
                       class="w-full px-4 py-2 bg-[var(--bg-tertiary)] border border-[var(--border)] rounded-xl focus:border-cyan-500 outline-none">
            </div>
            <div class="space-y-1">
                <label class="text-xs font-semibold text-[var(--text-muted)]">Custom Instructions for AI</label>
                <textarea name="custom_prompt" rows="4" placeholder="Talk more professionally / Use emojis / Remind them about the meeting..."
                          class="w-full px-4 py-2 bg-[var(--bg-tertiary)] border border-[var(--border)] rounded-xl focus:border-cyan-500 outline-none resize-none">{{ contact.custom_prompt or '' }}</textarea>
                <p class="text-[10px] text-[var(--text-muted)]">These instructions will be injected into the system prompt when replying to this number.</p>
            </div>
            <div class="pt-4 flex gap-3">
                <button type="button" onclick="document.getElementById('contact-modal').classList.add('hidden')"
                        class="flex-1 px-4 py-2 bg-[var(--bg-tertiary)] hover:bg-[var(--border)] rounded-xl font-semibold transition-colors">
                    Cancel
                </button>
                <button type="submit" class="flex-1 px-4 py-2 bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-600 hover:to-blue-700 text-white rounded-xl font-semibold shadow-lg">
                    Save Changes
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Scroll to bottom of chat
const chatContainer = document.getElementById('chat-container');
chatContainer.scrollTop = chatContainer.scrollHeight;

// Handle Contact Form
document.getElementById('contact-form').onsubmit = async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());
    if (data.age) data.age = parseInt(data.age);
    
    try {
        const response = await fetch('/api/contacts', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            location.reload();
        } else {
            alert('Failed to update contact');
        }
    } catch (err) {
        console.error(err);
        alert('Error updating contact');
    }
};

// Handle reply
document.getElementById('reply-form').onsubmit = async (e) => {
    e.preventDefault();
    const input = document.getElementById('reply-input');
    const message = input.value;
    if (!message) return;
    
    const btn = e.target.querySelector('button');
    btn.disabled = true;
    
    try {
        const response = await fetch('/api/send-sms', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                phone_number: '{{ phone }}',
                message: message
            })
        });
        
        if (response.ok) {
            input.value = '';
            location.reload();
        } else {
            alert('Failed to send message');
        }
    } catch (err) {
        console.error(err);
        alert('Error sending message');
    } finally {
        btn.disabled = false;
    }
};
</script>
{% endblock %}
